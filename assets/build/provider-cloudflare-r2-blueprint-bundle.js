(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var o in r)e.o(r,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:r[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.hooks,r=window.wp.i18n;class o{static ID="cloudflare-r2-blueprint-bundle";static NAME=(0,r.__)("Cloudflare R2","aether-site-exporter-providers");static TYPE="cloud-storage";static DESCRIPTION=(0,r.__)("Cloudflare R2 object storage for WordPress Playground blueprint bundles with zero egress fees.","aether-site-exporter-providers");static ICON="☁️";static DEPLOYMENT_TYPE="blueprint_bundle";static CONFIG_FIELDS=[{id:"account_id",label:(0,r.__)("Cloudflare Account ID","aether-site-exporter-providers"),type:"text",required:!0,sensitive:!0,validation:{pattern:"^[a-f0-9]{32}$",message:(0,r.__)("Account ID must be a 32-character hexadecimal string","aether-site-exporter-providers")}},{id:"api_token",label:(0,r.__)("Cloudflare API Token","aether-site-exporter-providers"),type:"text",required:!0,sensitive:!0,validation:{minLength:20,message:(0,r.__)("API Token must be at least 20 characters","aether-site-exporter-providers")}},{id:"bucket_name",label:(0,r.__)("Bucket Name","aether-site-exporter-providers"),type:"text",required:!0,sensitive:!1,validation:{pattern:"^[a-z0-9][a-z0-9-]{1,61}[a-z0-9]$",minLength:3,maxLength:63,message:(0,r.__)("Bucket name must be 3-63 characters, start and end with alphanumeric, and contain only lowercase letters, numbers, and hyphens","aether-site-exporter-providers")}},{id:"worker_endpoint",label:(0,r.__)("Worker Endpoint URL","aether-site-exporter-providers"),type:"url",required:!1,sensitive:!1,help:(0,r.__)("URL of the deployed Cloudflare Worker. Use the Deploy Worker button below to create one.","aether-site-exporter-providers")},{id:"access_key_id",label:(0,r.__)("R2 Access Key ID","aether-site-exporter-providers"),type:"text",required:!1,sensitive:!0,help:(0,r.__)("Only required for S3-compatible API access, not for Worker-based uploads.","aether-site-exporter-providers"),validation:{minLength:16,maxLength:128,message:(0,r.__)("Access Key ID must be between 16 and 128 characters","aether-site-exporter-providers")}},{id:"secret_access_key",label:(0,r.__)("R2 Secret Access Key","aether-site-exporter-providers"),type:"text",required:!1,sensitive:!0,help:(0,r.__)("Only required for S3-compatible API access, not for Worker-based uploads.","aether-site-exporter-providers"),validation:{minLength:32,maxLength:128,message:(0,r.__)("Secret Access Key must be between 32 and 128 characters","aether-site-exporter-providers")}},{id:"bundle_path",label:(0,r.__)("Bundle Path","aether-site-exporter-providers"),type:"text",required:!1,sensitive:!1,placeholder:"blueprint-bundle/bundle.zip",help:(0,r.__)("Path within the bucket for the blueprint bundle ZIP file","aether-site-exporter-providers")},{id:"public_url",label:(0,r.__)("Custom Domain (Optional)","aether-site-exporter-providers"),type:"url",required:!1,sensitive:!1,isAdvanced:!0}]}const n=window.wp.element,s=window.wp.components,i=window.wp.apiFetch;var a=e.n(i);const l=new Map;function d(e){return`${e.method||"GET"}:${e.path||""}:${e.data?JSON.stringify(e.data):""}`}const c=(e,t)=>{const r=d(e);if(l.has(r))return l.get(r);const o=t(e);return l.set(r,o),o.finally(()=>{l.delete(r)}),o},p=new Map,u={"/assets":6e5,"/settings":6e4,"/config":18e5,"/check-wporg":36e5};const h=(e,t)=>{if("GET"!==(e.method||"GET"))return t(e);const r=d(e),o=p.get(r);if(function(e,t){if(!e)return!1;const r=function(e){for(const[t,r]of Object.entries(u))if(e&&e.includes(t))return r;return 3e5}(t);return 0!==r&&Date.now()-e.timestamp<r}(o,e.path))return Promise.resolve(o.response);const n=t(e);return n.then(e=>(p.set(r,{response:e,timestamp:Date.now()}),e)).catch(e=>{throw e}),n};!function(){const e="undefined"!=typeof window&&window.aetherData&&window.aetherData.restUrl?window.aetherData.restUrl:"/wp-json/",t="undefined"!=typeof window&&window.aetherData&&window.aetherData.nonce?window.aetherData.nonce:"";a().use(a().createRootURLMiddleware(e)),t&&function(e){a().use(a().createNonceMiddleware(e))}(t),a().use(h),a().use(c)}();const y=a(),m={title:(0,r.__)("Required API Token Permissions","aether-site-exporter-providers"),sections:[{title:(0,r.__)("R2 Storage","aether-site-exporter-providers"),items:[{permission:"R2: Edit",description:(0,r.__)("Read and write files to R2 bucket","aether-site-exporter-providers")}]},{title:(0,r.__)("Workers (for deployment)","aether-site-exporter-providers"),items:[{permission:"Workers Scripts: Edit",description:(0,r.__)("Deploy and update Workers","aether-site-exporter-providers")},{permission:"Workers Routes: Edit",description:(0,r.__)("Attach custom domains to Workers","aether-site-exporter-providers")}]},{title:(0,r.__)("DNS (for custom domains)","aether-site-exporter-providers"),items:[{permission:"Zone: Read",description:(0,r.__)("Look up zone IDs for custom domains","aether-site-exporter-providers")}]}],createTokenUrl:"https://dash.cloudflare.com/profile/api-tokens"},f={title:(0,r.__)("Manual Worker Deployment","aether-site-exporter-providers"),steps:[(0,r.__)("Go to Cloudflare Dashboard > Workers & Pages","aether-site-exporter-providers"),(0,r.__)('Click "Create" and select "Create Worker"',"aether-site-exporter-providers"),(0,r.__)('Name your worker (e.g., "my-r2-static-site")',"aether-site-exporter-providers"),(0,r.__)("Go to Settings > Variables > R2 Bucket Bindings","aether-site-exporter-providers"),(0,r.__)('Add binding: Variable name "R2_BUCKET", select your bucket',"aether-site-exporter-providers"),(0,r.__)("Deploy the worker and copy the URL","aether-site-exporter-providers")],workersUrl:"https://dash.cloudflare.com/?to=/:account/workers-and-pages"},x={title:(0,r.__)("Manual Domain Attachment","aether-site-exporter-providers"),steps:[(0,r.__)("Go to Cloudflare Dashboard > Workers & Pages","aether-site-exporter-providers"),(0,r.__)("Select your worker","aether-site-exporter-providers"),(0,r.__)("Go to Settings > Triggers > Custom Domains","aether-site-exporter-providers"),(0,r.__)('Click "Add Custom Domain"',"aether-site-exporter-providers"),(0,r.__)("Enter your domain and confirm","aether-site-exporter-providers")],note:(0,r.__)("Ensure the domain is on the same Cloudflare account and proxied through Cloudflare (orange cloud).","aether-site-exporter-providers"),docsUrl:"https://developers.cloudflare.com/workers/configuration/routing/custom-domains/"},_="https://developers.cloudflare.com/workers/runtime-apis/bindings/",g=window.ReactJSXRuntime;function w(){const[e,t]=(0,n.useState)(!1),o={margin:"0.5rem 0 0.75rem",paddingLeft:"1.5rem"},i={marginBottom:"0.25rem"};return(0,g.jsxs)("div",{style:{marginBottom:"1rem",padding:"0.75rem 1rem",backgroundColor:"#f0f6fc",borderLeft:"4px solid #2271b1",borderRadius:"2px"},children:[(0,g.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:0},children:[(0,g.jsx)("strong",{children:(0,r.__)("Before you begin","aether-site-exporter-providers")}),(0,g.jsx)(s.Button,{variant:"link",onClick:()=>t(!e),style:{padding:0,height:"auto",minHeight:"auto"},"aria-expanded":e,children:e?(0,r.__)("Hide details","aether-site-exporter-providers"):(0,r.__)("Show details","aether-site-exporter-providers")})]}),!e&&(0,g.jsxs)("p",{style:{margin:"0.5rem 0 0",fontSize:"13px"},children:[(0,r.__)("You need a Cloudflare API token with R2, Workers, and Zone permissions.","aether-site-exporter-providers")," ",(0,g.jsx)(s.ExternalLink,{href:m.createTokenUrl,children:(0,r.__)("Create API Token","aether-site-exporter-providers")})]}),e&&(0,g.jsxs)("div",{style:{marginTop:"0.75rem",fontSize:"13px",lineHeight:"1.6"},children:[(0,g.jsx)("p",{style:{margin:"0 0 0.5rem"},children:(0,r.__)("Create a Cloudflare API token with these permissions:","aether-site-exporter-providers")}),m.sections.map((e,t)=>(0,g.jsxs)("div",{style:{marginBottom:"0.5rem"},children:[(0,g.jsx)("strong",{style:{fontSize:"12px",color:"#50575e"},children:e.title}),(0,g.jsx)("ul",{style:o,children:e.items.map((e,t)=>(0,g.jsxs)("li",{style:i,children:[(0,g.jsx)("code",{children:e.permission})," - ",e.description]},t))})]},t)),(0,g.jsx)("p",{style:{margin:0},children:(0,g.jsx)(s.ExternalLink,{href:m.createTokenUrl,children:(0,r.__)("Create API Token in Cloudflare Dashboard","aether-site-exporter-providers")})})]})]})}function v(){const[e,t]=(0,n.useState)(!1),o={marginBottom:"0.35rem"};return(0,g.jsxs)("div",{style:{marginTop:"0.5rem"},children:[(0,g.jsx)(s.Button,{variant:"link",onClick:()=>t(!e),style:{padding:0,height:"auto",minHeight:"auto",fontSize:"12px"},"aria-expanded":e,children:e?(0,r.__)("Hide token creation steps","aether-site-exporter-providers"):(0,r.__)("How to create an API token","aether-site-exporter-providers")}),e&&(0,g.jsxs)("div",{style:{marginTop:"0.5rem",padding:"0.75rem",backgroundColor:"#f6f7f7",borderRadius:"4px",fontSize:"12px",lineHeight:"1.6"},children:[(0,g.jsxs)("ol",{style:{margin:"0.5rem 0",paddingLeft:"1.25rem"},children:[(0,g.jsx)("li",{style:o,children:(0,r.__)("Go to Cloudflare Dashboard > My Profile > API Tokens","aether-site-exporter-providers")}),(0,g.jsx)("li",{style:o,children:(0,r.__)('Click "Create Token"',"aether-site-exporter-providers")}),(0,g.jsx)("li",{style:o,children:(0,r.__)('Select "Create Custom Token"',"aether-site-exporter-providers")}),(0,g.jsxs)("li",{style:o,children:[(0,r.__)("Add these permissions:","aether-site-exporter-providers"),(0,g.jsxs)("ul",{style:{marginTop:"0.25rem",marginBottom:"0.25rem",paddingLeft:"1.25rem",listStyleType:"disc"},children:[(0,g.jsx)("li",{children:"Account > Workers Scripts > Edit"}),(0,g.jsx)("li",{children:"Account > Workers Routes > Edit"}),(0,g.jsx)("li",{children:"Zone > Zone > Read (select your zones)"})]})]}),(0,g.jsx)("li",{style:o,children:(0,r.__)("Create the token and copy it here","aether-site-exporter-providers")})]}),(0,g.jsx)(s.ExternalLink,{href:"https://developers.cloudflare.com/fundamentals/api/get-started/create-token/",children:(0,r.__)("View Cloudflare Documentation","aether-site-exporter-providers")})]})]})}function k({errorType:e,hostname:t}){const[o,i]=(0,n.useState)(!1),a={marginTop:"0.5rem"},l={padding:0,height:"auto",minHeight:"auto",fontSize:"12px",color:"#2271b1"},d={marginTop:"0.5rem",padding:"0.75rem",backgroundColor:"#fff8e5",borderRadius:"4px",fontSize:"12px",lineHeight:"1.6"},c={margin:"0.5rem 0",paddingLeft:"1.25rem"},p={marginBottom:"0.35rem"};return"worker_deployment"===e?(0,g.jsxs)("div",{style:a,children:[(0,g.jsx)(s.Button,{variant:"link",onClick:()=>i(!o),style:l,"aria-expanded":o,children:o?(0,r.__)("Hide manual instructions","aether-site-exporter-providers"):(0,r.__)("How to deploy manually","aether-site-exporter-providers")}),o&&(0,g.jsxs)("div",{style:d,children:[(0,g.jsx)("p",{style:{margin:"0 0 0.5rem"},children:(0,r.__)("If automatic deployment fails, you can deploy the worker manually:","aether-site-exporter-providers")}),(0,g.jsx)("ol",{style:c,children:f.steps.map((e,t)=>(0,g.jsx)("li",{style:p,children:e},t))}),(0,g.jsx)(s.ExternalLink,{href:f.workersUrl,children:(0,r.__)("Open Workers & Pages","aether-site-exporter-providers")})," | ",(0,g.jsx)(s.ExternalLink,{href:_,children:(0,r.__)("View Bindings Documentation","aether-site-exporter-providers")})]})]}):"domain_attachment"===e?(0,g.jsxs)("div",{style:a,children:[(0,g.jsx)(s.Button,{variant:"link",onClick:()=>i(!o),style:l,"aria-expanded":o,children:o?(0,r.__)("Hide manual instructions","aether-site-exporter-providers"):(0,r.__)("How to attach domain manually","aether-site-exporter-providers")}),o&&(0,g.jsxs)("div",{style:d,children:[(0,g.jsx)("p",{style:{margin:"0 0 0.5rem"},children:(0,r.__)("If custom domain attachment fails, configure it manually:","aether-site-exporter-providers")}),(0,g.jsx)("ol",{style:c,children:x.steps.map((e,r)=>(0,g.jsx)("li",{style:p,children:4===r&&t?`${e}: ${t}`:e},r))}),(0,g.jsx)("p",{style:{marginTop:"0.5rem",fontStyle:"italic",color:"#50575e"},children:x.note}),(0,g.jsx)(s.ExternalLink,{href:x.docsUrl,children:(0,r.__)("View Custom Domains Documentation","aether-site-exporter-providers")})]})]}):null}const b="/* eslint-disable no-console */\n/**\n * Cloudflare Worker for R2 Static Site Serving\n *\n * Deploy this worker and add an R2 bucket binding named \"R2_BUCKET\"\n */\n\nconst CORS_HEADERS = {\n\t'Access-Control-Allow-Origin': '*',\n\t'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\n\t'Access-Control-Allow-Headers': 'Content-Type, X-R2-Key, X-R2-Content-Type, X-R2-Cache-Control, X-API-Key, X-R2-Action, X-R2-Upload-Id, X-R2-Part-Number',\n\t'Access-Control-Max-Age': '86400',\n};\n\nexport default {\n\tasync fetch(request, env) {\n\t\t// Handle CORS preflight\n\t\tif (request.method === 'OPTIONS') {\n\t\t\treturn new Response(null, { status: 204, headers: CORS_HEADERS });\n\t\t}\n\n\t\t// Handle GET requests (serve static files)\n\t\tif (request.method === 'GET') {\n\t\t\treturn handleGet(request, env);\n\t\t}\n\n\t\t// Handle POST requests (uploads)\n\t\tif (request.method === 'POST') {\n\t\t\treturn handlePost(request, env);\n\t\t}\n\n\t\treturn new Response(JSON.stringify({ error: 'Method not allowed' }), {\n\t\t\tstatus: 405,\n\t\t\theaders: { ...CORS_HEADERS, 'Content-Type': 'application/json' },\n\t\t});\n\t},\n};\n\nasync function handleGet(request, env) {\n\tconst url = new URL(request.url);\n\tlet path = url.pathname.slice(1); // Remove leading /\n\n\t// Handle directory index\n\tif (!path || path.endsWith('/')) {\n\t\tpath = path + 'index.html';\n\t}\n\n\t// Try to get the file\n\tlet object = await env.R2_BUCKET.get(path);\n\n\t// If not found and no extension, try as directory\n\tif (!object && !path.split('/').pop().includes('.')) {\n\t\tobject = await env.R2_BUCKET.get(path + '/index.html');\n\t}\n\n\tif (!object) {\n\t\treturn new Response('Not found', { status: 404 });\n\t}\n\n\tconst contentType = object.httpMetadata?.contentType || getContentType(path);\n\treturn new Response(object.body, {\n\t\theaders: {\n\t\t\t'Content-Type': contentType,\n\t\t\t'Cache-Control': 'public, max-age=3600',\n\t\t\t'Access-Control-Allow-Origin': '*',\n\t\t},\n\t});\n}\n\nasync function handlePost(request, env) {\n\tconst action = request.headers.get('X-R2-Action');\n\tconst key = request.headers.get('X-R2-Key');\n\n\t// Handle different actions\n\tif (action === 'delete') {\n\t\tconst body = await request.json();\n\t\tawait env.R2_BUCKET.delete(body.key);\n\t\treturn jsonResponse({ success: true });\n\t}\n\n\tif (action === 'list') {\n\t\tconst body = await request.json();\n\t\tconst listed = await env.R2_BUCKET.list({ prefix: body.prefix || '' });\n\t\treturn jsonResponse({\n\t\t\tsuccess: true,\n\t\t\tobjects: listed.objects.map(o => ({ key: o.key, size: o.size })),\n\t\t});\n\t}\n\n\t// Default: file upload\n\tif (!key) {\n\t\treturn jsonResponse({ success: false, error: 'Missing X-R2-Key header' }, 400);\n\t}\n\n\tconst contentType = request.headers.get('X-R2-Content-Type') || 'application/octet-stream';\n\tconst data = await request.arrayBuffer();\n\n\tawait env.R2_BUCKET.put(key, data, {\n\t\thttpMetadata: { contentType, cacheControl: 'public, max-age=3600' },\n\t});\n\n\treturn jsonResponse({ success: true, key, size: data.byteLength });\n}\n\nfunction jsonResponse(data, status = 200) {\n\treturn new Response(JSON.stringify(data), {\n\t\tstatus,\n\t\theaders: { ...CORS_HEADERS, 'Content-Type': 'application/json' },\n\t});\n}\n\nfunction getContentType(path) {\n\tconst ext = path.split('.').pop().toLowerCase();\n\tconst types = {\n\t\thtml: 'text/html', css: 'text/css', js: 'application/javascript',\n\t\tjson: 'application/json', png: 'image/png', jpg: 'image/jpeg',\n\t\tjpeg: 'image/jpeg', gif: 'image/gif', svg: 'image/svg+xml',\n\t\twebp: 'image/webp', woff: 'font/woff', woff2: 'font/woff2',\n\t};\n\treturn types[ext] || 'application/octet-stream';\n}";function j({isOpen:e,onClose:t,bucketName:o}){const[i,a]=(0,n.useState)(!1);if(!e)return null;const l={marginBottom:"1.5rem"},d={fontSize:"1rem",fontWeight:"600",marginBottom:"0.5rem",marginTop:0},c={margin:"0.5rem 0",paddingLeft:"1.5rem"},p={marginBottom:"0.5rem",lineHeight:"1.6"};return(0,g.jsx)(s.Modal,{title:(0,r.__)("Manual Worker Setup Instructions","aether-site-exporter-providers"),onRequestClose:t,style:{maxWidth:"800px",width:"90vw"},className:"aether-manual-worker-modal",children:(0,g.jsxs)("div",{className:"aether-manual-worker-modal__content",children:[(0,g.jsxs)("div",{style:l,children:[(0,g.jsx)("h3",{style:d,children:(0,r.__)("Step 1: Create a Worker","aether-site-exporter-providers")}),(0,g.jsxs)("ol",{style:c,children:[(0,g.jsxs)("li",{style:p,children:[(0,r.__)("Go to","aether-site-exporter-providers")," ",(0,g.jsx)("a",{href:"https://dash.cloudflare.com/?to=/:account/workers-and-pages",target:"_blank",rel:"noopener noreferrer",children:"Cloudflare Dashboard > Workers & Pages"})]}),(0,g.jsx)("li",{style:p,children:(0,r.__)('Click "Create" and select "Create Worker"',"aether-site-exporter-providers")}),(0,g.jsx)("li",{style:p,children:(0,r.__)('Name your worker (e.g., "aether-r2-mysite")',"aether-site-exporter-providers")}),(0,g.jsx)("li",{style:p,children:(0,r.__)('Click "Deploy" to create the worker with default code',"aether-site-exporter-providers")})]})]}),(0,g.jsxs)("div",{style:l,children:[(0,g.jsx)("h3",{style:d,children:(0,r.__)("Step 2: Add R2 Bucket Binding","aether-site-exporter-providers")}),(0,g.jsxs)("ol",{style:c,children:[(0,g.jsx)("li",{style:p,children:(0,r.__)("In your worker, go to Settings > Variables","aether-site-exporter-providers")}),(0,g.jsx)("li",{style:p,children:(0,r.__)('Scroll down to "R2 Bucket Bindings"',"aether-site-exporter-providers")}),(0,g.jsx)("li",{style:p,children:(0,r.__)('Click "Add binding"',"aether-site-exporter-providers")}),(0,g.jsxs)("li",{style:p,children:[(0,g.jsx)("strong",{children:(0,r.__)("Variable name:","aether-site-exporter-providers")})," ",(0,g.jsx)("code",{children:"R2_BUCKET"})," ",(0,r.__)("(must be exactly this name)","aether-site-exporter-providers")]}),(0,g.jsxs)("li",{style:p,children:[(0,g.jsx)("strong",{children:(0,r.__)("R2 bucket:","aether-site-exporter-providers")})," ",o?(0,g.jsxs)(g.Fragment,{children:[(0,r.__)("Select","aether-site-exporter-providers")," ",(0,g.jsx)("code",{children:o})]}):(0,r.__)("Select your R2 bucket","aether-site-exporter-providers")]}),(0,g.jsx)("li",{style:p,children:(0,r.__)('Click "Save" to save the binding',"aether-site-exporter-providers")})]})]}),(0,g.jsxs)("div",{style:l,children:[(0,g.jsx)("h3",{style:d,children:(0,r.__)("Step 3: Replace Worker Code","aether-site-exporter-providers")}),(0,g.jsxs)("ol",{style:c,children:[(0,g.jsx)("li",{style:p,children:(0,r.__)('Go to your worker\'s "Code" tab',"aether-site-exporter-providers")}),(0,g.jsx)("li",{style:p,children:(0,r.__)("Delete all existing code","aether-site-exporter-providers")}),(0,g.jsx)("li",{style:p,children:(0,r.__)("Paste the code below:","aether-site-exporter-providers")})]}),(0,g.jsxs)("div",{style:{position:"relative",marginTop:"0.5rem"},children:[(0,g.jsx)("div",{style:{display:"flex",justifyContent:"flex-end",marginBottom:"0.5rem"},children:(0,g.jsx)(s.Button,{variant:"secondary",onClick:async()=>{try{await navigator.clipboard.writeText(b),a(!0),setTimeout(()=>a(!1),3e3)}catch{const e=document.createElement("textarea");e.value=b,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),a(!0),setTimeout(()=>a(!1),3e3)}},disabled:i,children:i?(0,r.__)("Copied!","aether-site-exporter-providers"):(0,r.__)("Copy Code","aether-site-exporter-providers")})}),(0,g.jsx)(s.TextareaControl,{value:b,readOnly:!0,rows:15,style:{fontFamily:"monospace",fontSize:"12px",backgroundColor:"#1e1e1e",color:"#d4d4d4"}})]})]}),(0,g.jsxs)("div",{style:l,children:[(0,g.jsx)("h3",{style:d,children:(0,r.__)("Step 4: Deploy and Copy URL","aether-site-exporter-providers")}),(0,g.jsxs)("ol",{style:c,children:[(0,g.jsx)("li",{style:p,children:(0,r.__)('Click "Save and Deploy" to deploy your worker',"aether-site-exporter-providers")}),(0,g.jsx)("li",{style:p,children:(0,r.__)("Copy the worker URL (e.g., https://aether-r2-mysite.your-subdomain.workers.dev)","aether-site-exporter-providers")}),(0,g.jsx)("li",{style:p,children:(0,r.__)('Paste it in the "Worker Endpoint URL" field in this form',"aether-site-exporter-providers")})]})]}),(0,g.jsxs)(s.Notice,{status:"info",isDismissible:!1,children:[(0,g.jsx)("strong",{children:(0,r.__)("Important:","aether-site-exporter-providers")})," ",(0,r.__)('The R2 bucket binding variable name MUST be exactly "R2_BUCKET" (case-sensitive). The worker will not work without this binding.',"aether-site-exporter-providers")]}),(0,g.jsxs)("div",{style:{backgroundColor:"#f0f6fc",padding:"0.75rem 1rem",borderLeft:"4px solid #2271b1",borderRadius:"2px",marginTop:"1rem",fontSize:"0.875rem"},children:[(0,g.jsx)("strong",{children:(0,r.__)("Need more help?","aether-site-exporter-providers")}),(0,g.jsx)("br",{}),(0,g.jsx)("a",{href:_,target:"_blank",rel:"noopener noreferrer",children:(0,r.__)("R2 Bucket Bindings Documentation","aether-site-exporter-providers")})," | ",(0,g.jsx)("a",{href:"https://developers.cloudflare.com/r2/",target:"_blank",rel:"noopener noreferrer",children:(0,r.__)("R2 Overview","aether-site-exporter-providers")})]}),(0,g.jsx)("div",{style:{marginTop:"1.5rem",display:"flex",justifyContent:"flex-end"},children:(0,g.jsx)(s.Button,{variant:"primary",onClick:t,children:(0,r.__)("Close","aether-site-exporter-providers")})})]})})}function C({providerId:e,config:t,onChange:o}){const[i,a]=(0,n.useState)(!1),[l,d]=(0,n.useState)(null),[c,p]=(0,n.useState)(!1),[u,h]=(0,n.useState)(null),[m,f]=(0,n.useState)(!1);return(0,g.jsxs)("div",{style:{marginTop:"1rem",paddingTop:"1rem",borderTop:"1px solid #ddd"},children:[(0,g.jsxs)("div",{style:{display:"flex",gap:"0.5rem",alignItems:"center"},children:[(0,g.jsx)(s.Button,{variant:"secondary",onClick:async()=>{a(!0),d(null),p(!1),h(null);try{if(!t?.account_id||!t?.api_token||!t?.bucket_name)throw new Error((0,r.__)("Cloudflare Account ID, API Token, and Bucket Name are required to deploy the worker","aether-site-exporter-providers"));const n=(window.aetherData?.restUrl||window.wpApiSettings?.root||"/wp-json").replace(/\/$/,""),s=window.aetherData?.nonce||window.wpApiSettings?.nonce||"",i=`aether-r2-${Math.random().toString(36).substring(2,10)}`,a={};t.bucket_name&&(a.R2_BUCKET={type:"r2_bucket",bucket_name:t.bucket_name});const l=`${n}/aether/site-exporter/providers/cloudflare/deploy-worker`,d=await fetch(l,{method:"POST",headers:{"X-WP-Nonce":s,"Content-Type":"application/json"},body:JSON.stringify({worker_type:"r2",worker_name:i,bindings:a,account_id:t.account_id,api_token:t.api_token})});if(!d.ok){const e=await d.json().catch(()=>({message:`HTTP ${d.status}: ${d.statusText}`}));throw new Error(e.message||e.error||(0,r.__)("Failed to deploy worker","aether-site-exporter-providers"))}const c=await d.json();if(!c.success)throw new Error(c.message||c.error||(0,r.__)("Failed to deploy worker","aether-site-exporter-providers"));if(c.worker_url){o&&"function"==typeof o&&o("worker_endpoint",c.worker_url);try{const t=await y({path:`/aether/site-exporter/providers/${e}/config`,method:"GET"}),r=t?.config||{};await y({path:`/aether/site-exporter/providers/${e}/config`,method:"POST",data:{config:{...r,worker_endpoint:c.worker_url}}})}catch{}}p(!0),h(c.worker_url||null),setTimeout(()=>{p(!1)},1e4)}catch(e){d(e.message||(0,r.__)("Failed to deploy worker","aether-site-exporter-providers"))}finally{a(!1)}},isBusy:i,disabled:i||!t?.account_id||!t?.api_token||!t?.bucket_name,children:i?(0,r.__)("Deploying…","aether-site-exporter-providers"):(0,r.__)("Deploy Worker","aether-site-exporter-providers")}),(0,g.jsx)(s.Button,{variant:"tertiary",onClick:()=>f(!0),children:(0,r.__)("Manual Setup","aether-site-exporter-providers")})]}),l&&(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(s.Notice,{status:"error",isDismissible:!1,style:{marginTop:"0.5rem"},children:l}),(0,g.jsx)(k,{errorType:"worker_deployment"})]}),c&&(0,g.jsxs)(s.Notice,{status:"success",isDismissible:!1,style:{marginTop:"0.5rem"},children:[(0,r.__)("Worker deployed successfully!","aether-site-exporter-providers"),u&&(0,g.jsxs)("div",{style:{marginTop:"0.5rem"},children:[(0,g.jsx)("strong",{children:(0,r.__)("Worker URL:","aether-site-exporter-providers")})," ",(0,g.jsx)("a",{href:u,target:"_blank",rel:"noopener noreferrer",children:u})]})]}),(0,g.jsx)(j,{isOpen:m,onClose:()=>f(!1),bucketName:t?.bucket_name})]})}const T=new Map,R=new class{register(e,r){if(!e||"string"!=typeof e)throw new Error("ProviderRegistry.register() requires a valid provider ID string");if(!r||"function"!=typeof r)throw new Error("ProviderRegistry.register() requires a provider class");if(!r.ID)throw new Error(`Provider ${e} must have static ID property`);if(!r.NAME)throw new Error(`Provider ${e} must have static NAME property`);T.set(e,r),(0,t.doAction)("aether.providers.registered",e,r)}get(e){return T.get(e)||null}getAll(){return Array.from(T.values())}getAllIds(){return Array.from(T.keys())}getByDeploymentType(e){return this.getAll().filter(t=>t.DEPLOYMENT_TYPE===e)}getDefault(){const e=this.getByDeploymentType("static_site");if(e.length>0)return e[0];const t=this.getAll();return t.length>0?t[0]:null}getForDeploymentType(e){const t=this.getByDeploymentType(e);return t.length>0?t[0]:null}has(e){return T.has(e)}count(){return T.size}parseInstanceId(e){if(!e||"string"!=typeof e)return null;const t=e.split(":",2);return 2===t.length&&t[0]&&t[1]?{provider_type:t[0],uuid:t[1]}:null}getProviderForInstance(e){const t=this.parseInstanceId(e);return t?this.get(t.provider_type):null}createInstanceId(e){return`${e}:${"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}`}clear(){T.clear()}};(0,t.addAction)("aether.providers.register","aether/provider-registry",e=>{if(!e||"function"!=typeof e)return;const t=e.ID;t&&R.register(t,e)});let S=R;if("undefined"!=typeof window)if(window.aether=window.aether||{},window.aether.ProviderRegistry){const e=window.aether.ProviderRegistry;Array.from(T.values()).forEach(t=>{const r=t.ID;e.get(r)||e.register(r,t)}),S=e}else window.aether.ProviderRegistry=R;const E=S;function P(e,t){if(!e)return t;try{const r=JSON.parse(e);return r.errors&&Array.isArray(r.errors)&&r.errors.length>0&&r.errors[0].message?r.errors[0].message:r.error?"string"==typeof r.error?r.error:JSON.stringify(r.error):r.message?r.message:t}catch(r){return e||t}}function A(e=null,t=null){const r={success:!0,data:e};return t&&"object"==typeof e&&null!==e?r.data={...e,message:t}:t&&(r.data={message:t}),r}function D(e,t=null){const r={success:!1,error:"string"==typeof e?e:e?.message||"Unknown error"};return t&&Array.isArray(t)&&t.length>0&&(r.errors=t),r}const I=5242880;async function O(e,t,r,o,n){const s=await fetch(e,{method:"POST",headers:{"Content-Type":"application/octet-stream","X-R2-Key":t,"X-R2-Upload-Id":r,"X-R2-Part-Number":String(o)},body:n});return s.ok&&(await s.json()).etag||null}async function B(e,t,r){return(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"abort-multipart"},body:JSON.stringify({key:t,uploadId:r})})).ok}async function N(e,t="",r=1e3){const o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"list"},body:JSON.stringify({prefix:t,limit:r})});return o.ok?A({objects:(await o.json()).objects||[]}):D(P(await o.text(),`List failed: ${o.status}`))}class L{constructor(e,t,r={}){this.workerEndpoint=e,this.bucketName=t,this.config=r}async upload(e,t,r={}){if(!(t instanceof File||t instanceof Blob))return{success:!1,error:"File must be a File or Blob object"};const o={contentType:r.contentType||t.type,cacheControl:r.cacheControl||"",onProgress:r.onProgress||null},n=await async function(e,t,r,o={}){return r.size>20971520?async function(e,t,r,o={}){const n=r.size,s=o.contentType||r.type||"application/octet-stream",i=o.cacheControl||"",a=await async function(e,t,r,o){const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"initiate-multipart"},body:JSON.stringify({key:t,contentType:r,cacheControl:o})});return n.ok&&(await n.json()).uploadId||null}(e,t,s,i);if(!a)return D("Failed to initiate multipart upload");const l=[],d=Math.ceil(n/I),c=o.onProgress||null;for(let o=1;o<=d;o++){const s=(o-1)*I,i=Math.min(s+I,n),d=r.slice(s,i),p=await d.arrayBuffer(),u=await O(e,t,a,o,p);if(!u)return await B(e,t,a),D(`Failed to upload part ${o}`);if(l.push({partNumber:o,etag:u}),c){const e=o*I;c(Math.min(e,n),n,null)}}const p=await async function(e,t,r,o){return(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"complete-multipart"},body:JSON.stringify({key:t,uploadId:r,parts:o})})).ok}(e,t,a,l);return p?A():(await B(e,t,a),D("Failed to complete multipart upload"))}(e,t,r,o):async function(e,t,r,o={}){const n=o.contentType||r.type||"application/octet-stream",s=o.cacheControl||"",i=o.onProgress||null;return new Promise((o,a)=>{const l=new XMLHttpRequest;l.timeout=3e5,i&&l.upload.addEventListener("progress",e=>{if(e.lengthComputable){const t=Math.round(e.loaded/e.total*100);i(e.loaded,e.total,t)}}),l.addEventListener("timeout",()=>{a(new Error("Upload timed out after 300000ms"))}),l.addEventListener("load",()=>{if(l.status>=200&&l.status<300)return void o(A());let e=`Upload failed: ${l.status}`;e=P(l.responseText,e),o(D(e))}),l.addEventListener("error",()=>{a(new Error("Upload failed: network error"))}),l.addEventListener("abort",()=>{a(new Error("Upload aborted"))}),l.open("POST",e),l.setRequestHeader("Content-Type","application/octet-stream"),l.setRequestHeader("X-R2-Key",t),l.setRequestHeader("X-R2-Content-Type",n),s&&l.setRequestHeader("X-R2-Cache-Control",s),l.send(r)})}(e,t,r,o)}(this.workerEndpoint,e,t,o);return n.success?{success:!0,url:this.getUrl(e)}:n}async delete(e){return async function(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"delete"},body:JSON.stringify({key:t})});return r.ok?A():D(P(await r.text(),`Delete failed: ${r.status}`))}(this.workerEndpoint,e)}async copy(e,t){return async function(e,t,r){const o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"copy"},body:JSON.stringify({sourceKey:t,destKey:r})});return o.ok?A():D(P(await o.text(),`Copy failed: ${o.status}`))}(this.workerEndpoint,e,t)}async exists(e){const t=await N(this.workerEndpoint,e,1);return!!t.success&&(t.objects||[]).some(t=>t.key===e)}async listObjects(e="",t=1e3){return N(this.workerEndpoint,e,t)}getUrl(e){return this.config.public_url?`${this.config.public_url.replace(/\/$/,"")}/${e}`:function(e,t,r){return`${e.replace(/\/$/,"")}/${t}/${r}`}(this.workerEndpoint,this.bucketName,e)}async batchCopy(e){return async function(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"batch-copy"},body:JSON.stringify({operations:t})});if(!r.ok)return D(P(await r.text(),`Batch copy failed: ${r.status}`));const o=await r.json();return A({copied:o.copied||0,errors:o.errors||0,results:o.results||[]})}(this.workerEndpoint,e)}async batchDelete(e){return async function(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"batch-delete"},body:JSON.stringify({keys:t})});return r.ok?A():D(P(await r.text(),`Batch delete failed: ${r.status}`))}(this.workerEndpoint,e)}async downloadManifest(e){const t=`${e}/file-manifest.json`;try{return await async function(e,t){const r=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-R2-Action":"download"},body:JSON.stringify({key:t})});if(!r.ok){if(404===r.status)return null;const e=await r.text();throw new Error(`Download failed: ${r.status} - ${e}`)}return r.blob()}(this.workerEndpoint,t)}catch(e){return null}}async uploadManifest(e,t){const r=`${e}/file-manifest.json`;return await this.upload(r,t,{contentType:"application/json"})}async testConnection(){const e=await this.listObjects("",1);return e.success?{success:!0,message:"Successfully connected to Cloudflare R2."}:{success:!1,error:e.error||"Failed to list objects"}}}async function $(e){try{return(await y({path:`/aether/site-exporter/providers/${e}/config`,method:"GET"})).config||{}}catch(e){if("restProviderNotConfigured"===e.code||404===e.status)return{};throw e}}E.register(o.ID,o),(0,t.doAction)("aether.providers.register",o);const U=new Map;async function W(e){const t=await $(e);return t?.worker_endpoint&&t?.bucket_name?new L(t.worker_endpoint,t.bucket_name,{public_url:t.public_url||null}):null}var q;(0,t.addAction)("aether.file.upload","aether/cloudflare-r2-blueprint-bundle",e=>{e._uploadPromises||(e._uploadPromises=[]),e._uploadPromises.push(async function(e){const{fileType:t,providerId:r,filePath:o,storageKey:n}=e;if(!r||!r.startsWith("cloudflare-r2-blueprint-bundle"))return;if("blueprint-bundle"!==t)return;const s=`${r}:${n||o}`,i=U.get(s);if(!0===i)return;if(i instanceof Promise){try{await i}catch{U.get(s)===i&&U.delete(s)}if(!0===U.get(s))return}const a=(async()=>{try{const t=await W(r);if(!t)throw new Error("Storage service not available. Please configure worker_endpoint and bucket_name.");if(!o)throw new Error("Blueprint bundle file path is required");if(!o.startsWith("http://")&&!o.startsWith("https://"))throw new Error("Blueprint bundle must be provided as a URL for R2 uploads");const s=await fetch(o,{method:"GET",credentials:"omit"});if(!s.ok)throw new Error(`Failed to fetch blueprint bundle: HTTP ${s.status}`);const i=await $(r),a=n||i?.bundle_path||"blueprint-bundle/bundle.zip",l=await t.upload(a,await s.blob(),{contentType:"application/zip"});if(!l.success)throw new Error(l.error||"Blueprint bundle upload failed");e.result={success:!0,url:l.url}}catch(t){throw e.result={success:!1,error:t.message||"Unknown error"},t}U.set(s,!0)})().catch(e=>{throw U.get(s)===a&&U.delete(s),e});U.set(s,a),await a}(e))},10),(0,t.addFilter)("aether.provider.test","aether/cloudflare-r2-blueprint-bundle",(e,t)=>t?.startsWith("cloudflare-r2-blueprint-bundle")?async()=>{const e=await W(t);return e?e.testConnection():{success:!1,error:"Storage service not configured. Please set worker_endpoint and bucket_name."}}:e,10),(0,t.addFilter)("aether.provider.upload_strategy","aether/cloudflare-r2-blueprint-bundle",(e,t)=>t?.startsWith("cloudflare-r2-blueprint-bundle")?"worker":e,10),q="cloudflare-r2-blueprint-bundle",(0,t.addFilter)("aether.admin.provider.modal.header",`aether/${q}/setup-guide`,(e,t)=>t.providerId?.startsWith(q)?(0,g.jsx)(w,{}):e),(0,t.addFilter)("aether.admin.provider.field.after",`aether/${q}/api-token-help`,(e,t)=>"api_token"===t.fieldId&&t.providerId?.startsWith(q)?(0,g.jsxs)(g.Fragment,{children:[e,(0,g.jsx)(v,{})]}):e,5),(0,t.addFilter)("aether.admin.provider.field.after",`aether/${q}/deploy-button`,(e,t)=>"worker_endpoint"===t.fieldId&&t.providerId?.startsWith(q)?(0,g.jsxs)(g.Fragment,{children:[e,(0,g.jsx)(C,{providerId:t.providerId,config:t.formValues||{},onChange:t.onFormChange})]}):e,10)})();